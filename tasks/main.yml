---

- name: Install letsencrypt
  apt: pkg=letsencrypt state=installed

- name: Letsencript before action
  shell: name='{{ item }}'
  with_items:
    - '{{ letsencrypt_before }}'

- name: Stop renew services
  service: name='{{ item }}' state=stopped
  with_items:
    - '{{ letsencrypt_renew_services }}'

- name: Generate letsencrypt certificates
  command: /usr/bin/letsencrypt certonly --standalone --standalone-supported-challenges {{ letsencrypt_challenge }} --non-interactive --agree-tos --email {{ letsencrypt_email }} --domains {{ item }}
  args:
    creates: /etc/letsencrypt/live/{{ item }}/privkey.pem
  with_items: '{{ letsencrypt_domains }}'

- name: Start renew services
  service: name='{{ item }}' state=started
  with_items:
    - '{{ letsencrypt_renew_services }}'

- name: Letsencript after action
  shell: name='{{ item }}'
  with_items:
    - '{{ letsencrypt_after }}'

- name: Copy letsencrypt renew script
  template: src=etc/letsencrypt/renew.sh.j2 dest=/etc/letsencrypt/renew.sh owner=root group=root mode=0755

- name: Add crontab to renew certificates
  cron: name="letsencrypt renew" minute="0" hour="6,16" job="/etc/letsencrypt/renew.sh  > /dev/null" user="root" state="{{ letsencrypt_cron|ternary('present', 'absent') }}"
